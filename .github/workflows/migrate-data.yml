name: Data Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  migrate-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Setup Google Cloud credentials
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
    
    - name: Run Firestore migration
      run: npx tsx scripts/migrate_to_firestore.ts
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
        FIRESTORE_PROJECT_ID: aiengi
    
    - name: Migration summary
      run: |
        echo "### Migration Summary :database:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Project**: aiengi" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Complete" >> $GITHUB_STEP_SUMMARY
        echo "- **Collections**: items, classes, spells, races, feats, backgrounds, enemies, skills" >> $GITHUB_STEP_SUMMARY
